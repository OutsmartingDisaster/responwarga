# 2025-12-05 – Emergency Ops, Data Sharing & Overwatch Plan

## 1. Purpose & Scope

This document describes how **Respon Warga** will evolve to better support:

- **Emergency Operations** (live incident room, tasking, escalation)
- **Data Sharing & Interoperability** (secure exports, partner APIs, webhooks)
- **Super Admin Overwatch** (multi-organization monitoring and governance)
- **Orthophoto Support** (imagery pipeline for situational awareness)

It is aligned with the **Org_Dashboard v1.0 design system** in `docs/2025-12-02_design-system.md`.
All new UI work MUST follow that design for layout, colors, components, and interactions.

---

## 2. Current Capabilities Snapshot (Codebase Today)

High-level map of what already exists:

- **Super Admin Console – Mohon Ijin** (`/mohonijin/dashboard`)
  - Primary console for global configuration and oversight (super_admin console).
  - Tabs for Emergency Reports, Contributions, Crowdsourcing, Spreadsheets, Users, Organizations, Content, etc.
  - Uses a dark, control-room style UI that is already close to Org_Dashboard.
  - Currently restricts access to users with profile role `admin` or `super_admin`; target is that this acts as the global **super_admin console**.

- **Crowdsourcing Management**
  - `CrowdsourcingManager` lists projects, filters by status, links to submissions, moderators, analytics.
  - Export capability exists via `/api/crowdsourcing/export/:id?format=csv`.

- **Organization Management**
  - `OrganizationManager` shows organizations, responder counts, and assignments.
  - Provides a base for multi-org views, but not yet a full super_admin global overview.

- **Responder Dashboard & Offline Hooks**
  - Responder-oriented dashboard and hooks for offline field reports and real-time notifications.
  - These will be important foundations for emergency tasking and live incident room UX.

- **Database & Auth**
  - PostgreSQL with SQL migrations in `db/migrations/` and custom auth tables (`auth.users`, `auth.sessions`, `profiles`, `organizations`).
  - Some existing code still uses a Supabase-like API client; part of the roadmap is to converge on a single access pattern.

- **Maps & Basemap Config**
  - Custom grey/dark basemaps in `src/lib/map/config.ts`, used across crowdsource and dashboard maps.
  - No orthophoto overlay implemented yet.

This document builds on these pieces rather than starting from scratch.

---

## 3. Design System Alignment for UI

All dashboard and control-room views MUST follow `docs/2025-12-02_design-system.md`:

- **Dark-by-default surfaces** using the Void / Glass palette and subtle borders.
- **Bento-style layout**: widgets/cards arranged in a grid rather than a single long scroll.
- **Glass Cards** for panels, with blurred backgrounds and soft borders.
- **Lucide icons** with consistent sizing and weights.
- **Semantic colors** for incident priority and status (red / orange / green / purple).
- **Micro-interactions** such as pulses for "Live" indicators and hover transitions.

Whenever this document refers to a new UI view (for example, Live Incident Room, Global Situation Dashboard), the default assumption is:

- Built as a composition of **glass cards** and **widgets**.
- Follows the typography and spacing rules in the design system.
- Uses consistent Tailwind classes from the design system for colors, shadows, and states.

---

## 4. Feature Groups & Target Experience

### 4.1 Emergency Operations

**Goal:** Give operations teams a single place to see incidents, prioritize them, assign teams, and track progress in near real-time.

**Key Experiences:**

- **Live Incident Room**
  - Central feed combining emergency reports, crowdsource submissions, major alerts.
  - Map panel with incident markers and (future) orthophoto overlays.
  - Action bar for acknowledge / assign / escalate / close.

- **Field Team Tasking**
  - From an incident, quickly create assignments for specific teams.
  - Track status: unassigned → assigned → en route → on scene → completed.
  - Show response time indicators (SLA vs actual).

- **Priority & Escalation Rules**
  - Auto-tagging of priority based on content, location, or vulnerable groups.
  - Time-based escalations if no one acknowledges high-priority incidents.
  - Clear audit trail of who did what and when.

All Emergency Ops UI surfaces should follow the Org_Dashboard guidelines for bento layout and semantic status colors.

---

### 4.2 Data Sharing & Interoperability

**Goal:** Allow organizations to safely share data (internally and externally) without manual copying or risking sensitive information.

**Key Experiences:**

- **Scoped Exports**
  - Admins select time range, region/geofence, incident types.
  - Export to CSV/GeoJSON with built-in anonymization for sensitive fields.

- **Partner APIs**
  - API keys per partner/organization with scopes: read_org_data, read_aggregated_data, etc.
  - Standard JSON/GeoJSON responses for incidents, crowdsource submissions, and statistics.

- **Event Webhooks**
  - Push notifications to partner systems for high-priority events.
  - Configurable per-partner, with basic retry and logging.

UI for export configuration, API key management, and webhook setup should reuse the design system’s glass cards, button styles, and status badges.

---

### 4.3 Super Admin Overwatch (Multi-Organization)

**Goal:** Provide national or central coordinators with a cross-organization view of activity, health, and compliance.

**Key Experiences:**

- **Global Situation Dashboard**
  - Cross-org widgets: active incidents, backlog, average response times.
  - Map heatmaps by province/organization, with drill-down to org-level dashboards.

- **Organization Health & Compliance**
  - Indicators for login activity, data freshness, backlogs, and error rates.
  - Signals for possible under-reporting or overload.

- **Access & Audit**
  - Clearly defined `super_admin` role with read-mostly cross-org access.
  - Detailed audit log of super_admin actions.

Visually, this dashboard should look like an extension of the Org_Dashboard: same nav structure, colors, and card patterns, but at a national scope.

---

### 4.4 Orthophoto Support

**Goal:** Enable ingestion and use of high-resolution aerial imagery (e.g., drone orthophotos) for flood/damage assessment and planning.

**Conceptual Pipeline:**

- **Ingestion:** Upload GeoTIFF or register a file path; create a database record with status `pending`.
- **Processing:** Background worker converts to COG, generates thumbnail, extracts geographic bounds, and updates status.
- **Storage:** Store COG + thumbnail paths and spatial envelope; optionally clean up original files.
- **Map Integration:** Allow users to toggle orthophoto overlays in dashboards and incident views.
- **Ops & Monitoring:** Track processing times, failures, and storage usage.

UI overlays and controls for orthophotos should use the design system’s guidance on map overlays, blur, and indicators (for example, pulsing borders for recently updated imagery).

---

## 5. Implementation Roadmap (High-Level Phases)

This is a suggested order for implementation work, to be executed in the **dev environment** first.

### Phase 0 – Foundations & Cleanup

- Clarify and document **single source of truth** for:
  - Auth (custom `auth.users` + `auth.sessions` vs any Supabase remnants).
  - Database migrations (`db/migrations/` and how they are run).
  - Environment and ports (dev vs Docker).
- Align existing admin/responder dashboards with `2025-12-02_design-system.md` where they diverge.
- Ensure roles (`admin`, `super_admin`, `responder`, etc.) are consistent in database and code.

### Phase 1 – Emergency Operations v1

- Implement a first version of **Live Incident Room** using existing emergency reports and crowdsourcing data.
- Add tasking and simple status lifecycle for field assignments.
- Surface basic SLA/latency metrics in widgets on the dashboard.

### Phase 2 – Data Sharing v1

- Improve and standardize export endpoints for CSV/GeoJSON with anonymization.
- Build UI for exports and API-key management using the design system.
- Add minimal, well-scoped partner APIs for read-only access.

### Phase 3 – Super Admin Overwatch v1

- Introduce a **super_admin**-only global dashboard using existing organization and incident stats.
- Define and enforce cross-org access rules.
- Implement basic audit logging for admin/super_admin actions.

### Phase 4 – Orthophoto v1

- Implement orthophoto ingestion and background processing.
- Add simple overlays and footprint visualization on the map.
- Gradually integrate orthophotos into Emergency Ops workflows.

---

## 6. Detailed TODO Backlog (Role-Aligned)

This backlog is intentionally high-level but actionable. Individual items should become issues/tickets.

All UI changes MUST follow `docs/2025-12-02_design-system.md` (colors, glass cards, bento layout, typography, icon sizing).

### 6.1 Backend & Data Model (Shared)

- [x] **Unify incident representation** ✅
  - Created `incident_events` view combining emergency_reports + crowdsource_submissions.
  - Standardized fields: id, source_type, organization_id, disaster_type, incident_status, location.
  - Status mapping: open, in_review, resolved.

- [x] **Assignments and roles** ✅
  - Assignment API at `/api/mohonijin/incidents/[id]/assign`.
  - Roles enforced: super_admin, admin can assign; responders receive notifications.

- [x] **Orthophoto schema** ✅
  - Migration `20251205_002_orthophotos.sql` with full schema.
  - Includes: status, file paths, bounds, disaster linkage, organization_id, uploaded_by.

- [x] **Orthophoto tiling & delivery** ✅
  - Created `orthophoto_tiles` table for XYZ tile cache.
  - Created `tile_generation_queue` for background job management.
  - API: `/api/mohonijin/orthophotos/[id]/tiles` to queue and check tile generation.
  - Note: Actual tile generation requires external worker (GDAL/rio-tiler).

- [x] **Derived geospatial products from orthophotos** ✅
  - Created `derived_vectors` table for vector layers (flood extent, damage footprints, etc.).
  - Migration: `20251205_004_geospatial_products.sql`.
  - API: `/api/mohonijin/vectors` for CRUD operations on vector layers.
  - Supports: flood_extent, damage_footprint, road_blockage, shelter_area, custom types.

- [x] **Data sharing primitives** ✅
  - Anonymization rules in `anonymization_rules` table with defaults for phone, name, email.
  - API key scopes: read_org_data, read_aggregated_data, read_public_data.

### 6.2 Super Admin Console – `/mohonijin` (Global)

#### Emergency Operations (Global View)

- [x] **Elevate Emergency tab into a Live Incident overview** ✅
  - Created `LiveIncidentRoom.tsx` with glass-card bento layout.
  - Stats cards: total incidents, open, in_review, resolved.
  - Mini map widget with incident markers (`IncidentMiniMap.tsx`).

- [x] **Global Live Incident Room (v1)** ✅
  - "Live Incidents" tab in `/mohonijin/dashboard`.
  - Filters by status and source type; shows org for each incident.
  - Click to view details and assign responders via `IncidentDetailModal.tsx`.

#### Data Sharing & Interoperability (Global Policy)

- [ ] **Global export and API policy screen**
  - In `/mohonijin`, add a configuration view for:
    - Which fields are always anonymized in exports/APIs.
    - Which organizations may publish open/aggregated data.
  - Represent policies in a glass-card grid; reference semantic colors for risk levels.

- [x] **Global view of API keys and usage** ✅
  - `ApiKeyManager.tsx` lists all API keys with usage stats.
  - Shows: name, prefix, scopes, rate limit, last used, request count.
  - Create, activate/deactivate, revoke functionality.

#### Overwatch & Org Health

- [x] **Global Situation Dashboard (v1)** ✅
  - `GlobalSituation.tsx` with bento cards for cross-org metrics.
  - 14-day trend chart, disaster type breakdown, top provinces.
  - API: `/api/mohonijin/global-stats`.

- [x] **Organization health cards** ✅
  - `OrgHealthCards.tsx` with per-org health indicators.
  - Metrics: responders, open tasks, backlog, completed tasks.
  - Health score (0-100), status badges, issue flags.
  - API: `/api/mohonijin/org-health`.

#### Audit & Access Controls

- [x] **Super admin audit log** ✅
  - Created `admin_audit_log` table (migration `20251205_003_audit_log.sql`).
  - API: `/api/mohonijin/audit-log` for GET/POST.
  - `AuditLog.tsx` component with filters and table view.
  - Integrated as "Audit Log" tab in `/mohonijin/dashboard`.

- [x] **Tighten `/mohonijin` access semantics** ✅ (Documented)
  - Current: `admin` + `super_admin` access allowed.
  - Future plan: Restrict to `super_admin` only.
  - Migration: Promote key admins to super_admin, demote others to org_admin.
  - Timeline: After org admin dashboards are fully adopted.

### 6.3 Org Admin Dashboard (Per Organization)

> NOTE: Route: `/[organization]/admin/dashboard`. This section describes behavior for org admins.

#### Emergency Operations (Org Scope)

- [x] **Org-level Incident Room** ✅
  - Created `IncidentsTab.tsx` with org-scoped incident list.
  - API: `/api/org/incidents` filters by user's organization.
  - Assignment modal to dispatch tasks to responders.
  - Stats cards: total, open, in_review, resolved.

- [x] **Assignment & team overview** ✅
  - API: `/api/org/stats` provides org-level metrics.
  - API: `/api/org/responders` lists responders with assignment counts.
  - Existing TeamTab shows active responders.

#### Data Sharing (Org Scope)

- [x] **Scoped exports UI for org_admin** ✅
  - Created `ExportsTab.tsx` with format selection (CSV/JSON/GeoJSON).
  - Filters: status, source type, date range, limit.
  - Anonymization toggle for PII.
  - API: `/api/org/export` scoped to user's organization.

- [x] **Org-level API key management** ✅
  - Created `ApiKeysTab.tsx` for org admins.
  - Create/revoke API keys scoped to organization.
  - Keys limited to `read_org_data` scope.
  - API: `/api/org/api-keys`.

#### Org Configuration & Health

- [x] **Org configuration panel** ✅
  - Created `ConfigTab.tsx` for org admins.
  - API: `/api/org/config` for GET/PATCH.
  - Settings: name, description, contact info, address, website, language, timezone.

- [x] **Org health summary** ✅
  - Created `OrgHealthSummary.tsx` with health score calculation.
  - Shows: open incidents, active responders, pending tasks, 7-day trend.
  - Health flags: no responders, high backlog, overloaded.
  - Integrated as "Health" tab in org admin dashboard.

### 6.4 Responder Dashboard (Field Ops)

#### Tasks & Status

- [x] **"My Tasks" view** ✅ (Existing at `/responder/dashboard`)
  - `MyAssignmentsList.tsx` shows assignments with status, priority, location.
  - Filter by: all, pending, in_progress, completed.
  - Quick actions: Accept, Start, Complete, Navigate.

- [x] **Status & availability controls** ✅
  - Created `StatusControl.tsx` component.
  - API: `/api/responder/status` for GET/PATCH status.
  - Status options: on_duty, active, off_duty, inactive.
  - Shows task counts: pending, active, completed.

#### Map & Orthophoto Context

- [x] **Incident map with overlays** ✅
  - Created `TaskMap.tsx` component for responders.
  - Shows active tasks with priority-colored markers.
  - User location support.
  - Quick navigation to Google Maps.
  - Dark-themed CARTO basemap.

- [x] **Lightweight orthophoto interactions** ✅
  - Updated `TaskMap.tsx` with orthophoto layer toggle.
  - API: `/api/orthophotos/available` to find orthophotos by location.
  - Layer panel shows available orthophotos with thumbnails.
  - Toggle on/off with visual indicator.

### 6.5 Ops & Dev Workflow

- [x] **Dev-first rollout** ✅
  - All new features implemented on dev environment (port 4000).
  - Documentation updated in `docs/2025-12-05_new.md`.

- [x] **Monitoring & alerts** ✅
  - Created `/api/health` endpoint for basic health checks.
  - Created `/api/mohonijin/system-status` for detailed metrics.
  - Metrics: incidents, orgs, users, API usage, export stats, queue status.

This document remains the top-level map; all implementation details and code changes must be done incrementally in the `dev` environment, with issues/tickets derived from the TODO items above.

---

## 7. Future Optimizations (Post-v1)

Once the backlog above is implemented and stable, focus shifts from "add features" to "make them sharper, faster, and safer".

At a high level, future work can target:

- **Performance & Scale**
  - Use observability data (metrics/traces) to tune slow endpoints (incident feeds, exports, orthophoto queries).
  - Add smarter caching and pre-aggregation for heavy dashboards (global situation, org health).
  - Consider partitioning high-volume tables and adding PgBouncer when real load demands it.

- **UX & Workflow Refinement**
  - Instrument key flows for super_admin, org_admin, and responders; reduce clicks and context switches.
  - Add better defaults and noise reduction (smarter filters, clearer priorities, tuned notifications).
  - Introduce playbook-style shortcuts for common disaster scenarios.

- **Reliability & Operations**
  - Define SLOs (incident latency, export success rate, orthophoto processing time) and alert on SLO breaches.
  - Strengthen backup/restore drills and create concise runbooks for each critical feature.

- **Governance, Privacy & Sharing**
  - Refine data retention and consent models per organization and data type.
  - Harden open data endpoints with aggregation/thresholds to prevent re-identification.

- **Developer Experience**
  - Extract shared Org_Dashboard components (cards, health tiles, incident rows, map overlays) into a reusable library.
  - Expand automated tests (unit, integration, e2e) for cross-role flows and heavy operations.

These optimizations should be planned only after v1 capabilities are in regular use, guided by real-world usage, performance metrics, and feedback from emergency operations teams.

## 8. Implementation Log – 2025-12-05 (Backend, dev only)

- **Unified incident view (`incident_events`)**
  - Added migration `20251205_001_incident_events.sql` to create a Postgres view `incident_events`.
  - Scope v1: `emergency_reports` + `crowdsource_submissions` (joined to `crowdsource_projects` for `disaster_type`).
  - Normalizes an `incident_status` field across sources using:
    - Emergency reports: map `dispatch_status` (`unassigned`/`dispatched`/`acknowledged` → `open`; `assigned`/`in_progress` → `in_review`; `resolved` → `resolved`).
    - Crowdsource submissions: map `status` (`pending` → `open`; `approved`/`flagged` → `in_review`; `rejected` → `resolved`).
  - Exposes a minimal unified shape: `id`, `source_type`, `organization_id`, `disaster_type`, `assistance_type`, `status`, `incident_status`, `dispatch_status`, `latitude`, `longitude`, `location_name`, `created_at`, `updated_at`.
  - Does **not** yet include field reports or contributions; those can be added in a later v2 of the view.

- **TypeScript incident model & helper**
  - Added `src/types/incidents.ts` defining shared types: `IncidentSourceType`, `IncidentStatus`, and `Incident` aligned to `incident_events`.
  - Added `src/lib/db/incidents.ts` with a small helper `listIncidents(filters)` that:
    - Queries `incident_events` via the Node `pg` pool.
    - Accepts optional filters: `organizationId`, `status` (`open` | `in_review` | `resolved`), `sourceType`, `since`, and `limit`.
    - Converts numeric lat/lng from text to `number | null` for use in maps/dashboards.
  - This helper is intended to be the single backend access point for Live Incident views (global and per-org) and for future exports/APIs.

- **Status of TODO 6.1 – Unify incident representation**
  - Backend v1 is in place as a read-only view + helper; existing UIs still read from their original tables.
  - Further work (separate tickets):
    - Include field reports / contributions if desired in the same unified feed.
    - Backfill or compute `severity`/`urgency` once data sources are ready.
    - Migrate `/mohonijin` and org-level dashboards to use `incident_events` instead of direct table reads.

- **Live Incident Room UI (Phase 1 – Emergency Operations v1)**
  - Added `LiveIncidentRoom.tsx` component to `/mohonijin/dashboard/components/`.
  - Features:
    - **Stats cards**: Total incidents, Open, In Review, Resolved – using glass-card design system.
    - **Filters**: Status filter (all/open/in_review/resolved), Source filter (all/emergency_report/crowdsource_submission).
    - **Incident list**: Scrollable list with status badges, source badges, time ago, location.
    - **Mini map widget**: `IncidentMiniMap.tsx` with dark basemap, circle markers colored by status, legend overlay.
    - **Auto-refresh**: Fetches incidents every 30 seconds.
    - **Map toggle**: Button to show/hide map for responsive layout.
  - Integrated as new "Live Incidents" tab in `/mohonijin/dashboard` sidebar (radio icon).
  - Uses unified `incident_events` view via `/api/mohonijin/incidents` endpoint.
  - Follows `2025-12-02_design-system.md`: glass cards, semantic colors, bento layout, Lucide icons.

- **Field Team Tasking (Phase 1 – Emergency Operations v1)**
  - Added `IncidentDetailModal.tsx` component for viewing incident details and creating assignments.
  - New API endpoints:
    - `GET /api/mohonijin/incidents/[id]` – Get incident details with assignments.
    - `GET /api/mohonijin/responders` – List available responders with active assignment counts.
    - `POST /api/mohonijin/incidents/[id]/assign` – Create assignment for incident.
  - Features:
    - **Incident detail view**: Shows status, source type, disaster type, location, organization.
    - **Assignment list**: Shows all assignments for the incident with status badges.
    - **Assignment form**: Select responder, priority (low/normal/high/urgent), add notes.
    - **Notifications**: Auto-creates notification for assigned responder.
    - **Status update**: Updates `dispatch_status` on emergency reports when assigned.
  - Assignment status lifecycle: `pending` → `accepted` → `in_progress` → `completed` (or `declined`).

- **Data Sharing v1 (Phase 2)**
  - **Database migration** `20251205_001_api_keys.sql`:
    - `api_keys` table for partner API key management
    - `api_key_usage_log` for audit trail
    - `export_history` for tracking exports
    - `anonymization_rules` for configurable PII anonymization
  - **Export API** `/api/mohonijin/export/incidents`:
    - Filters: status, sourceType, disasterType, organizationId, startDate, endDate, limit
    - Formats: JSON, CSV, GeoJSON
    - Built-in anonymization for PII (phone, name, email)
    - Export history logging for audit
  - **API Key Management** `/api/mohonijin/api-keys`:
    - Create/list/update/revoke API keys
    - Scopes: `read_org_data`, `read_aggregated_data`, `read_public_data`
    - Rate limiting configuration
    - Usage tracking and statistics
  - **UI Components**:
    - `DataExports.tsx` – Export configuration with format selection, filters, anonymization toggle
    - `ApiKeyManager.tsx` – Create, view, activate/deactivate, revoke API keys
  - Integrated as "Data Exports" and "API Keys" tabs in `/mohonijin/dashboard`

- **Super Admin Overwatch v1 (Phase 3)**
  - **Global Stats API** `/api/mohonijin/stats`:
    - Incident counts (total, open, in_review, resolved, last 24h, last 7d)
    - Breakdown by disaster type and province
    - 14-day daily trend data
    - Organization, responder, and assignment statistics
  - **Organization Health API** `/api/mohonijin/org-health`:
    - Per-org metrics: responders, open tasks, backlog, completed tasks
    - Health score calculation (0-100) based on multiple factors
    - Health status: healthy/warning/critical
    - Flags: no_active_responders, high_backlog, overloaded, inactive
  - **UI Components**:
    - `GlobalSituation.tsx` – Cross-org dashboard with stat cards, 14-day trend chart, disaster type breakdown, top provinces
    - `OrgHealthCards.tsx` – Organization health cards with metrics, health score bar, status badges, filterable by health status
  - Integrated as "Global Situation" and "Org Health" tabs in `/mohonijin/dashboard`

- **Orthophoto v1 (Phase 4)**
  - **Database migration** `20251205_002_orthophotos.sql`:
    - `orthophotos` table for imagery metadata and file references
    - Geographic bounds (WGS84), capture date, resolution, file size
    - Status tracking: pending, processing, ready, failed, archived
    - `orthophoto_processing_queue` for background job management
    - `orthophoto_coverage` view for spatial queries
  - **Orthophoto API** `/api/mohonijin/orthophotos`:
    - `GET` – List orthophotos with filters (status, organization, disaster type)
    - `POST` – Upload new orthophoto with file and metadata
    - `GET /[id]` – Get orthophoto details with processing job status
    - `PATCH /[id]` – Update orthophoto metadata
    - `DELETE /[id]` – Delete orthophoto and associated files
  - **UI Component** `OrthophotoManager.tsx`:
    - Grid view with thumbnails and status badges
    - Upload modal with metadata form (name, description, org, disaster type, capture date)
    - File upload support for GeoTIFF
    - Status filter
    - Delete functionality
  - Integrated as "Orthophotos" tab in `/mohonijin/dashboard`
  - Note: Background processing (COG conversion, thumbnail generation) requires separate worker implementation
